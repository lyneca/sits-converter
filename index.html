<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="style.css" type="text/css" rel="stylesheet">
    <title>Canvas to SITS Converter</title>
</head>

<body>
    <div class="title">
        <div class="title-text">
        Ratification Documentation Preparation Utility
        </div>
        <img class="usyd-logo" src="usyd-logo.png" alt="The University of Sydney">
    </div>
    <div class="container">
        <div class="step" id="step-1">
            <div class="step-instructions">
                <div class="step-number">1</div>
                <div class="main-instruction">
                    Upload Files from Canvas
                </div>
                <div class="sub-instruction">
                    This is the exported .csv file from the marking center
                </div>
            </div>
            <div class="upload-box" id="file-input-csv">
                <div class="upload-box-text">
                    <!--<div class="upload-icon">IN</div>-->
                    <div class="upload-status none-uploaded">
                        Drag the file straight into this box
                    </div>
                    <div class="upload-file"></div>
                </div>
            </div>
        </div>
        <div class="step" id="step-2">
            <div class="step-instructions">
                <div class="step-number">2</div>
                <div class="main-instruction">
                    Upload Files from SITS
                </div>
                <div class="sub-instruction">
                    This is the exported .xls file from the student center
                </div>
            </div>
            <div class="upload-box" id="file-input-sits">
                <div class="upload-box-text">
                    <!--<div class="upload-icon">IN</div>-->
                    <div class="upload-status none-uploaded">
                        Drag the file straight into this box
                    </div>
                    <div class="upload-file"></div>
                </div>
            </div>
        </div>
        <div class="step" id="step-3">
            <div class="step-instructions">
                <div class="step-number">3</div>
                <div class="main-instruction">
                    Download & Save Merged File
                </div>
            </div>
            <div class="button" id="merge-button">
                Merge
            </div>
        </div>

        <script>
            const { dialog } = require('electron').remote
            // Set up file drag-and-drop
            var csvInput = document.getElementById('file-input-csv');
            var sitsInput = document.getElementById('file-input-sits');
            var button = document.getElementById('merge-button');

            csvInput.ondragover = () => { csvInput.classList.add("dragover"); return false };
            csvInput.ondragleave = () => { csvInput.classList.remove("dragover"); return false };
            csvInput.ondragend = () => { csvInput.classList.remove("dragover"); return false };

            sitsInput.ondragover = () => { sitsInput.classList.add("dragover"); return false };
            sitsInput.ondragleave = () => { sitsInput.classList.remove("dragover"); return false };
            sitsInput.ondragend = () => { sitsInput.classList.remove("dragover"); return false };

            csvInput.ondrop = function(e) {
                e.preventDefault();
                this.classList.remove("dragover");
                if (isDisabled(this)) return false;
                csvFile = e.dataTransfer.files[0].path;
                visualHandler(this, csvFile)
                enableStep(2);
                return false;
            };

            sitsInput.ondrop = function(e) {
                e.preventDefault();
                this.classList.remove("dragover");
                if (isDisabled(this)) return false;
                sitsFile = e.dataTransfer.files[0].path;
                visualHandler(this, sitsFile)
                enableStep(3);
                return false;
            };

            function visualHandler(element, fileName) {
                element.classList.remove("dragover")
                element.classList.add("uploaded");
                console.log(element);
                element.children[0].children[0].textContent = "Success! File upload complete.";
                element.children[0].children[1].textContent = fileName.replace(/^.*[\\\/]/, '');
            }

            function isDisabled(element) {
                return element.parentElement.classList.contains("disabled");
            }

            csvInput.onclick = function() {
                if (isDisabled(this)) return false;
                var tmp = dialog.showOpenDialog({
                    multiSelections: false
                });
                if (tmp) {
                    csvFile = tmp;
                    visualHandler(csvInput, csvFile)
                }
                enableStep(2);
            };

            sitsInput.onclick = function() {
                if (isDisabled(this)) return false;
                var tmp = dialog.showOpenDialog({
                    multiSelections: false
                });
                if (tmp) {
                    sitsFile = tmp;
                    visualHandler(sitsInput, sitsFile)
                }
                enableStep(3);
            };

            button.onclick = () => {
                sitsInput.classList.remove("uploaded");
                csvInput.classList.remove("uploaded");
                if (csvFile && sitsFile) process(csvFile, sitsFile);
                reset();
            }

            function reset() {
                disableStep(2);
                disableStep(3);
                csvInput.children[0].children[0].textContent = "Drag the file straight into this box";
                csvInput.children[0].children[1].textContent = "No file uploaded";
                sitsInput.children[0].children[0].textContent = "Complete the above step first";
                sitsInput.children[0].children[1].textContent = "No file uploaded";
                console.log(sitsInput);
            }
            </script>
        <script src="script.js"></script>
        <script>
            reset();
        </script>
        </div>
        </body>
</html>